name: Auto Execute Competition Draws

on:
  schedule:
    # Run every 15 minutes to check for draws that need execution
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  execute-draws:
    runs-on: ubuntu-latest
    steps:
      - name: Auto Execute Competition Draws
        run: |
          curl -X POST '${{ secrets.SUPABASE_URL }}/functions/v1/auto-execute-draws' \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n" \
            -o response.json

          echo "Response:"
          cat response.json
          echo ""

          # Check if the request was successful
          if [ $(jq -r '.success' response.json) = "true" ]; then
            echo "✅ Auto draw execution completed successfully!"
            echo "Total competitions checked: $(jq -r '.data.total_competitions' response.json)"
            echo "Successful draws: $(jq -r '.data.successful_draws' response.json)"
            echo "Failed draws: $(jq -r '.data.failed_draws' response.json)"

            # Display executed draws
            if [ $(jq -r '.data.successful_draws' response.json) -gt 0 ]; then
              echo ""
              echo "Draws executed:"
              jq -r '.data.draws_executed[] | "  - \(.competition_title): Winner #\(.winning_ticket_number) (\(.winner_display_name))"' response.json
            fi

            # Display errors if any
            if [ $(jq -r '.data.failed_draws' response.json) -gt 0 ]; then
              echo ""
              echo "⚠️  Errors encountered:"
              jq -r '.data.errors[] | "  - \(.competition_title): \(.error)"' response.json
            fi

            exit 0
          else
            echo "❌ Auto draw execution failed!"
            exit 1
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "Automatic draw execution failed. Please check the logs."
          # Add notification logic here (e.g., send email, Slack message, etc.)
